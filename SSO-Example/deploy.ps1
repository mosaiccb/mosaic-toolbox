# üåê Frontend Deployment Script - PowerShell
# Deploy React TypeScript Frontend with Azure Developer CLI and GitHub Backup
# 
# Author: GitHub Copilot AI Assistant
# Created: July 2025
# Purpose: Complete frontend deployment pipeline with error checking and GitHub backup
#
# This script will:
# 1. Check prerequisites (Node.js, Azure CLI, azd)
# 2. Install dependencies and build the frontend
# 3. Run type checking and linting for error detection
# 4. Deploy using Azure Developer CLI (azd deploy)
# 5. Test the deployment
# 6. Backup code to GitHub on successful deployment
#
# üîß Configuration:
#   ‚Ä¢ Frontend: React TypeScript with Vite
#   ‚Ä¢ Deployment: Azure Static Web Apps via azd deploy
#   ‚Ä¢ Repository: mosaiccb/ukg-sync-frontend
#
# Usage Examples:
#   .\deploy.ps1                                        # Full deployment with GitHub backup
#   .\deploy.ps1 -SkipBuild                            # Skip npm build step
#   .\deploy.ps1 -SkipTests                            # Skip type checking and linting
#   .\deploy.ps1 -NoGitBackup                          # Deploy without GitHub backup
#   .\deploy.ps1 -CommitMessage "Update dashboard"     # Custom commit message
#   .\deploy.ps1 -VerboseOutput                        # Verbose output

param(
    [Parameter(Mandatory = $false)]
    [switch]$SkipBuild,
    
    [Parameter(Mandatory = $false)]
    [switch]$SkipTests,
    
    [Parameter(Mandatory = $false)]
    [switch]$NoGitBackup,
    
    [Parameter(Mandatory = $false)]
    [switch]$VerboseOutput,
    
    [Parameter(Mandatory = $false)]
    [string]$CommitMessage = "üåê Frontend deployment: Restaurant Operations Dashboard updates"
)

Write-Host "üåê Starting Frontend Deployment Pipeline" -ForegroundColor Green
Write-Host "üìÖ Deployment initiated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor DarkGray
Write-Host "üë§ Executed by: $env:USERNAME on $env:COMPUTERNAME" -ForegroundColor DarkGray

# Check prerequisites
Write-Host "`nüìã Checking prerequisites..." -ForegroundColor Cyan

# Check if Node.js is installed
try {
    $nodeVersion = node --version 2>$null
    if ($nodeVersion) {
        Write-Host "‚úÖ Node.js: $nodeVersion" -ForegroundColor Green
    }
    else {
        Write-Host "‚ùå Node.js not found. Please install Node.js" -ForegroundColor Red
        Write-Host "üí° Download from: https://nodejs.org/" -ForegroundColor Cyan
        exit 1
    }
}
catch {
    Write-Host "‚ùå Node.js not found. Please install Node.js" -ForegroundColor Red
    exit 1
}

# Check if npm is available
try {
    $npmVersion = npm --version 2>$null
    if ($npmVersion) {
        Write-Host "‚úÖ npm: $npmVersion" -ForegroundColor Green
    }
    else {
        Write-Host "‚ùå npm not found" -ForegroundColor Red
        exit 1
    }
}
catch {
    Write-Host "‚ùå npm not found" -ForegroundColor Red
    exit 1
}

# Check if Azure CLI is installed and logged in
try {
    $azVersion = az version 2>$null
    if (-not $azVersion) {
        Write-Host "‚ùå Azure CLI not found. Please install Azure CLI" -ForegroundColor Red
        Write-Host "üí° Download from: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli" -ForegroundColor Cyan
        exit 1
    }
    
    $azAccount = az account show 2>$null | ConvertFrom-Json
    if ($azAccount) {
        Write-Host "‚úÖ Azure CLI authenticated as: $($azAccount.user.name)" -ForegroundColor Green
        Write-Host "üìç Subscription: $($azAccount.name)" -ForegroundColor Cyan
    }
    else {
        Write-Host "‚ùå Azure CLI not authenticated" -ForegroundColor Red
        Write-Host "üí° Run: az login" -ForegroundColor Cyan
        exit 1
    }
}
catch {
    Write-Host "‚ùå Error checking Azure CLI: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# Check if Azure Developer CLI (azd) is installed
try {
    $azdVersion = azd version 2>$null
    if ($azdVersion) {
        Write-Host "‚úÖ Azure Developer CLI: $($azdVersion | Select-String 'azd version' | ForEach-Object { $_.ToString().Split(' ')[2] })" -ForegroundColor Green
    }
    else {
        Write-Host "‚ùå Azure Developer CLI (azd) not found" -ForegroundColor Red
        Write-Host "üí° Install with: winget install microsoft.azd" -ForegroundColor Cyan
        Write-Host "üí° Or download from: https://aka.ms/azd-install" -ForegroundColor DarkGray
        exit 1
    }
}
catch {
    Write-Host "‚ùå Azure Developer CLI (azd) not found" -ForegroundColor Red
    exit 1
}

# Check if we're in the right directory
if (-not (Test-Path "package.json")) {
    Write-Host "‚ùå package.json not found. Make sure you're in the ukg-sync-frontend directory" -ForegroundColor Red
    exit 1
}

if (-not (Test-Path "azure.yaml")) {
    Write-Host "‚ùå azure.yaml not found. Make sure you're in the ukg-sync-frontend directory" -ForegroundColor Red
    exit 1
}

Write-Host "‚úÖ Prerequisites check completed" -ForegroundColor Green

# Check Git status
Write-Host "`nüìã Checking Git status..." -ForegroundColor Cyan

try {
    $isGitRepo = Test-Path ".git"
    if ($isGitRepo) {
        $gitStatus = git status --porcelain 2>$null
        if ($gitStatus) {
            Write-Host "‚ö†Ô∏è  Uncommitted changes detected:" -ForegroundColor Yellow
            $gitStatusLines = $gitStatus -split "`n"
            foreach ($line in $gitStatusLines | Select-Object -First 5) {
                if ($line.Trim()) {
                    Write-Host "   $line" -ForegroundColor Yellow
                }
            }
            Write-Host "üí° Changes will be committed after successful deployment" -ForegroundColor DarkGray
        }
        else {
            Write-Host "‚úÖ Working directory is clean" -ForegroundColor Green
        }
        
        $currentBranch = git branch --show-current 2>$null
        if ($currentBranch) {
            Write-Host "üìç Current branch: $currentBranch" -ForegroundColor Cyan
        }
    }
    else {
        Write-Host "üìÅ Not a Git repository" -ForegroundColor Yellow
        $NoGitBackup = $true
    }
}
catch {
    Write-Host "üìÅ Git not available" -ForegroundColor Yellow
    $NoGitBackup = $true
}

# Install dependencies and build (unless skipped)
if (-not $SkipBuild) {
    Write-Host "`nüì¶ Installing dependencies..." -ForegroundColor Cyan
    npm install
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå npm install failed" -ForegroundColor Red
        exit 1
    }
    Write-Host "‚úÖ Dependencies installed successfully" -ForegroundColor Green
    
    # Run type checking (unless skipped)
    if (-not $SkipTests) {
        Write-Host "`nüîç Running type check..." -ForegroundColor Cyan
        npm run type-check
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå TypeScript type checking failed" -ForegroundColor Red
            Write-Host "üí° Fix type errors before deployment" -ForegroundColor Cyan
            exit 1
        }
        Write-Host "‚úÖ Type checking passed" -ForegroundColor Green
        
        Write-Host "`nüìù Running linter..." -ForegroundColor Cyan
        npm run lint
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è  Linting failed, but continuing deployment" -ForegroundColor Yellow
            Write-Host "üí° Consider fixing linting issues for better code quality" -ForegroundColor DarkGray
        }
        else {
            Write-Host "‚úÖ Linting passed" -ForegroundColor Green
        }
    }
    else {
        Write-Host "‚è≠Ô∏è  Skipping type checking and linting (-SkipTests specified)" -ForegroundColor Yellow
    }
    
    Write-Host "`nüî® Building frontend..." -ForegroundColor Cyan
    npm run build
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Build failed" -ForegroundColor Red
        exit 1
    }
    Write-Host "‚úÖ Build completed successfully" -ForegroundColor Green
    
    # Verify build output
    if (Test-Path "dist") {
        $distFiles = Get-ChildItem "dist" -Recurse | Measure-Object
        Write-Host "üìÅ Build output: $($distFiles.Count) files in dist folder" -ForegroundColor DarkGray
    }
    else {
        Write-Host "‚ö†Ô∏è  dist folder not found after build" -ForegroundColor Yellow
    }
}
else {
    Write-Host "‚è≠Ô∏è  Skipping build (-SkipBuild specified)" -ForegroundColor Yellow
}

# Deploy using Azure Developer CLI
Write-Host "`nüöÄ Deploying with Azure Developer CLI..." -ForegroundColor Cyan

# Check if azd is initialized
if (-not (Test-Path ".azure")) {
    Write-Host "‚ö†Ô∏è  Azure Developer CLI not initialized for this project" -ForegroundColor Yellow
    Write-Host "üí° Run 'azd init' first to set up the project" -ForegroundColor Cyan
    exit 1
}

try {
    Write-Host "Executing: azd deploy" -ForegroundColor DarkGray
    azd deploy
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Azure deployment failed" -ForegroundColor Red
        exit 1
    }
    Write-Host "‚úÖ Azure deployment completed successfully" -ForegroundColor Green
}
catch {
    Write-Host "‚ùå Azure deployment failed: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}

# Get deployment information
Write-Host "`nüîç Getting deployment information..." -ForegroundColor Cyan
try {
    $azdShowOutput = azd show 2>$null
    if ($azdShowOutput) {
        Write-Host "üìç Deployment details:" -ForegroundColor Cyan
        $azdShowOutput | ForEach-Object { Write-Host "   $_" -ForegroundColor DarkGray }
    }
}
catch {
    Write-Host "üîç Could not retrieve deployment details" -ForegroundColor DarkGray
}

# Test the deployment
Write-Host "`nüß™ Testing deployment..." -ForegroundColor Cyan
Start-Sleep -Seconds 3

# Try to get the URL from azd show or use a reasonable default
$frontendUrl = $null
try {
    $azdEnv = azd env get-values 2>$null
    if ($azdEnv) {
        $urlLine = $azdEnv | Where-Object { $_ -match "SERVICE_WEB_URI" }
        if ($urlLine) {
            $frontendUrl = ($urlLine -split "=")[1].Trim('"')
        }
    }
}
catch {
    Write-Host "üîç Could not get frontend URL from azd" -ForegroundColor DarkGray
}

if ($frontendUrl) {
    try {
        Write-Host "Testing frontend at: $frontendUrl" -ForegroundColor DarkGray
        $response = Invoke-WebRequest -Uri $frontendUrl -Method GET -TimeoutSec 10 -UseBasicParsing
        if ($response.StatusCode -eq 200) {
            Write-Host "‚úÖ Frontend is accessible and responding" -ForegroundColor Green
            Write-Host "üåê Frontend URL: $frontendUrl" -ForegroundColor Cyan
        }
        else {
            Write-Host "‚ö†Ô∏è  Frontend responded with status: $($response.StatusCode)" -ForegroundColor Yellow
        }
    }
    catch {
        Write-Host "‚ö†Ô∏è  Could not test frontend URL: $($_.Exception.Message)" -ForegroundColor Yellow
        Write-Host "üí° The deployment may still be successful, but the URL is not accessible yet" -ForegroundColor DarkGray
    }
}
else {
    Write-Host "üîç Frontend URL not available for testing" -ForegroundColor DarkGray
    Write-Host "üí° Check Azure portal for the deployed Static Web App URL" -ForegroundColor Cyan
}

# GitHub backup (if not skipped and Git is available)
if (-not $NoGitBackup -and (Test-Path ".git")) {
    Write-Host "`nüì§ Backing up to GitHub..." -ForegroundColor Cyan
    
    try {
        # Add all changes
        git add -A
        
        # Check if there are changes to commit
        $gitStatus = git status --porcelain 2>$null
        if ($gitStatus) {
            # Commit changes
            git commit -m "$CommitMessage"
            Write-Host "‚úÖ Changes committed locally" -ForegroundColor Green
            
            # Push to GitHub
            Write-Host "Pushing to GitHub..." -ForegroundColor Yellow
            git push origin main
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Successfully backed up to GitHub" -ForegroundColor Green
                
                # Show commit info
                $commitHash = git rev-parse HEAD 2>$null
                if ($commitHash) {
                    Write-Host "üìç Commit hash: $($commitHash.Substring(0,8))" -ForegroundColor DarkGray
                }
            }
            else {
                Write-Host "‚ö†Ô∏è  Failed to push to GitHub" -ForegroundColor Yellow
                Write-Host "üí° You may need to push manually later" -ForegroundColor DarkGray
            }
        }
        else {
            Write-Host "‚úÖ No changes to commit - repository is up to date" -ForegroundColor Green
        }
    }
    catch {
        Write-Host "‚ö†Ô∏è  GitHub backup failed: $($_.Exception.Message)" -ForegroundColor Yellow
        Write-Host "üí° Deployment was successful, but Git backup failed" -ForegroundColor DarkGray
    }
}
elseif ($NoGitBackup) {
    Write-Host "‚è≠Ô∏è  Skipping GitHub backup (-NoGitBackup specified)" -ForegroundColor Yellow
}
else {
    Write-Host "‚è≠Ô∏è  Skipping GitHub backup (not a Git repository)" -ForegroundColor Yellow
}

Write-Host "`nüéâ Frontend deployment pipeline completed!" -ForegroundColor Green
if ($frontendUrl) {
    Write-Host "üåê Frontend URL: $frontendUrl" -ForegroundColor Cyan
}
Write-Host "üí° Check Azure portal for detailed deployment status" -ForegroundColor DarkGray

Write-Host "`n‚ú® Script execution completed successfully!" -ForegroundColor Green
